import json   # To read the results generated by the GPU node
import matplotlib.pyplot as plt # For generating the final comparative bar chart
import numpy as np # For numerical operations and calculating bar offsets

def plot_comparison(all_results):
    """
    Creates a grouped bar chart comparing the three models across all regimes.
    """
    # Extract the regimes (Neutral, Consistent, Counter-Cheat)
    # We assume all models were tested against the same regimes
    regimes = list(next(iter(all_results.values())).keys())
    model_names = list(all_results.keys())
    
    x = np.arange(len(regimes)) # Label locations
    width = 0.25 # Width of the individual bars
    
    fig, ax = plt.subplots(figsize=(12, 7))
    
    # Professional color palette: Grey (Original), Blue (CT), Orange (DANN)
    colors = ['#95a5a6', '#3498db', '#e67e22'] 
    
    # Plot each model's results
    for i, model_name in enumerate(model_names):
        accuracies = [all_results[model_name][r] for r in regimes]
        offset = (i - 1) * width # Offsets the bars so they don't overlap
        rects = ax.bar(x + offset, accuracies, width, label=model_name, color=colors[i])
        
        # Add the numeric percentage labels on top of each bar
        ax.bar_label(rects, padding=3, fmt='%.1f%%', fontweight='bold', fontsize=9)

    # Styling the chart for a research paper
    ax.set_ylabel('Nim Accuracy (%)', fontsize=12, fontweight='bold')
    ax.set_title('Comparative Performance: Identity Erasure vs. Logic Retention', fontsize=14, fontweight='bold')
    ax.set_xticks(x)
    ax.set_xticklabels(regimes, fontsize=11)
    ax.set_ylim(0, 115) # Leave vertical space for the text labels
    ax.legend(loc='upper left', frameon=True, shadow=True)
    ax.grid(axis='y', linestyle='--', alpha=0.5)

    plt.tight_layout()
    # Save as high-resolution PNG
    plt.savefig('nim_model_comparison.png', dpi=300)
    print("Plot successfully saved as 'nim_model_comparison.png'")
    plt.show()

if __name__ == "__main__":
    try:
        with open("eval_results_summary.json", "r") as f:
            data = json.load(f)
        plot_comparison(data)
    except FileNotFoundError:
        print("Error: 'eval_results_summary.json' not found. Run the GPU eval script first!")